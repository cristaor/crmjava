<?xml version="1.0" encoding="ISO-8859-1"?>
<DATASTRUCT>
  <ROWSETS>
    <INIT>
    </INIT>
    <ROWSET>
      <ACTION>
        <FROM>K_DOMAINS</FROM>
        <TO>K_DOMAINS</TO>
        <WHERE>ID_DOMAIN=?</WHERE>
        <FROM_PK>ID_DOMAIN</FROM_PK>
        <TO_PK>ID_DOMAIN</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFERENCED">ID_DOMAIN,ID_DOMAIN</MAPPING>
        <MAPPING>SYSDATE,DT_CREATED</MAPPING>
        <MAPPING>'{#DomainNm}',NM_DOMAIN</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_WORKAREAS</FROM>
        <TO>K_WORKAREAS</TO>
        <WHERE>GU_WORKAREA IN (SELECT GU_WORKAREA FROM K_WORKAREAS WHERE ID_DOMAIN=?)</WHERE>
        <FROM_PK>ID_DOMAIN,NM_WORKAREA</FROM_PK>
        <TO_PK>ID_DOMAIN,NM_WORKAREA</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="NEWGUID">GU_WORKAREA,GU_WORKAREA</MAPPING>
        <MAPPING>'assign from k_users after exec',GU_OWNER</MAPPING>
        <MAPPING>{#DomainId},ID_DOMAIN</MAPPING>
        <MAPPING>SYSDATE,DT_CREATED</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_USERS</FROM>
        <TO>K_USERS</TO>
        <WHERE>ID_DOMAIN=?</WHERE>
        <FROM_PK>ID_DOMAIN,TX_NICKNAME</FROM_PK>
        <TO_PK>ID_DOMAIN,TX_NICKNAME</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="NEWGUID">GU_USER,GU_USER</MAPPING>
        <MAPPING TRANSFORM="REFER(K_DOMAINS.ID_DOMAIN)">ID_DOMAIN,ID_DOMAIN</MAPPING>
        <MAPPING>LOWER(NM_USER||'@hipergate-{#DomainNm}.com'),TX_MAIN_EMAIL</MAPPING>
        <MAPPING>'{#DomainNm}',TX_SURNAME1</MAPPING>
        <MAPPING>'{#DomainNm}',TX_PWD</MAPPING>
        <MAPPING TRANSFORM="REFER(K_WORKAREAS.GU_WORKAREA)">GU_WORKAREA,GU_WORKAREA</MAPPING>
        <MAPPING>NULL,GU_CATEGORY</MAPPING>
        <MAPPING>SYSDATE,DT_CREATED</MAPPING>
      </MAPPINGS>
      <AFTER>
        <EXEC>UPDATE K_WORKAREAS SET GU_OWNER=(SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN={#DomainId} AND NM_USER LIKE 'Admin%') WHERE ID_DOMAIN={#DomainId}</EXEC>
      </AFTER>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_X_PORTLET_USER</FROM>
        <TO>K_X_PORTLET_USER</TO>
        <WHERE>ID_DOMAIN=?</WHERE>
        <FROM_PK>ID_DOMAIN,GU_USER,GU_WORKAREA,NM_PORTLET,NM_PAGE,NM_ZONE</FROM_PK>
        <TO_PK>ID_DOMAIN,GU_USER,GU_WORKAREA,NM_PORTLET,NM_PAGE,NM_ZONE</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFER(K_USERS.GU_USER)">GU_USER,GU_USER</MAPPING>
        <MAPPING TRANSFORM="REFER(K_WORKAREAS.GU_WORKAREA)">GU_WORKAREA,GU_WORKAREA</MAPPING>
      </MAPPINGS>
    </ROWSET>    
    <ROWSET>
      <ACTION>
        <FROM>K_ACL_GROUPS</FROM>
        <TO>K_ACL_GROUPS</TO>
        <WHERE>NM_ACL_GROUP LIKE 'MODEL%' AND ID_DOMAIN=?</WHERE>
        <FROM_PK>ID_DOMAIN,NM_ACL_GROUP</FROM_PK>
        <TO_PK>ID_DOMAIN,NM_ACL_GROUP</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="NEWGUID">GU_ACL_GROUP,GU_ACL_GROUP</MAPPING>
        <MAPPING TRANSFORM="REFER(K_DOMAINS.ID_DOMAIN)">ID_DOMAIN,ID_DOMAIN</MAPPING>
        <MAPPING>'{#DomainNm}'||' '||SUBSTR(NM_ACL_GROUP,INSTR(NM_ACL_GROUP, '/')),NM_ACL_GROUP</MAPPING>
      </MAPPINGS>
      <AFTER>
        <EXEC>UPDATE K_DOMAINS SET GU_OWNER=(SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN={#DomainId} AND NM_USER LIKE 'Admin%'), GU_ADMINS=(SELECT GU_ACL_GROUP FROM K_ACL_GROUPS WHERE ID_DOMAIN={#DomainId} AND NM_ACL_GROUP='{#DomainNm} / Administrators') WHERE ID_DOMAIN={#DomainId}</EXEC>
      </AFTER>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_X_GROUP_USER</FROM>
        <TO>K_X_GROUP_USER</TO>
        <WHERE>GU_USER IN (SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN=?)</WHERE>
        <FROM_PK>GU_ACL_GROUP,GU_USER</FROM_PK>
        <TO_PK>GU_ACL_GROUP,GU_USER</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFER(K_USERS.GU_USER)">GU_USER,GU_USER</MAPPING>
        <MAPPING TRANSFORM="REFER(K_ACL_GROUPS.GU_ACL_GROUP)">GU_ACL_GROUP,GU_ACL_GROUP</MAPPING>
        <MAPPING>SYSDATE,DT_CREATED</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_CATEGORIES</FROM>
        <TO>K_CATEGORIES</TO>
        <WHERE>NM_CATEGORY LIKE 'MODEL%' AND GU_OWNER IN (SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN=?)</WHERE>
        <FROM_PK>GU_CATEGORY</FROM_PK>
        <TO_PK>GU_CATEGORY</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="NEWGUID">GU_CATEGORY,GU_CATEGORY</MAPPING>
        <MAPPING TRANSFORM="REFER(K_USERS.GU_USER)">GU_OWNER,GU_OWNER</MAPPING>
        <MAPPING>NVL(UPPER('{#DomainNm}')||DECODE(SUBSTR(NM_CATEGORY,INSTR(nm_category,'_')),'MODEL',NULL,SUBSTR(NM_CATEGORY,INSTR(NM_CATEGORY,'_'))),UPPER('{#DomainNm}')),NM_CATEGORY</MAPPING>
        <MAPPING>SYSDATE,DT_CREATED</MAPPING>
        <MAPPING>NULL,DT_MODIFIED</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_CAT_LABELS</FROM>
        <TO>K_CAT_LABELS</TO>
        <WHERE>GU_CATEGORY IN (SELECT GU_CATEGORY FROM K_CATEGORIES WHERE NM_CATEGORY LIKE 'MODEL%' AND GU_OWNER IN (SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN=?))</WHERE>
        <FROM_PK>GU_CATEGORY,ID_LANGUAGE</FROM_PK>
        <TO_PK>GU_CATEGORY,ID_LANGUAGE</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFER(K_CATEGORIES.GU_CATEGORY)">GU_CATEGORY,GU_CATEGORY</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_CAT_TREE</FROM>
        <TO>K_CAT_TREE</TO>
        <WHERE>GU_CHILD_CAT IN (SELECT GU_CATEGORY FROM K_CATEGORIES WHERE NM_CATEGORY LIKE 'MODEL%' AND GU_OWNER IN (SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN=?))</WHERE>
        <FROM_PK>GU_PARENT_CAT,GU_CHILD_CAT</FROM_PK>
        <TO_PK>GU_PARENT_CAT,GU_CHILD_CAT</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFER(K_CATEGORIES.GU_CATEGORY)">GU_PARENT_CAT,GU_PARENT_CAT</MAPPING>
        <MAPPING TRANSFORM="REFER(K_CATEGORIES.GU_CATEGORY)">GU_CHILD_CAT,GU_CHILD_CAT</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_CAT_ROOT</FROM>
        <TO>K_CAT_ROOT</TO>
        <WHERE>GU_CATEGORY IN (SELECT GU_CATEGORY FROM K_CATEGORIES WHERE NM_CATEGORY LIKE 'MODEL%' AND GU_OWNER IN (SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN=?))</WHERE>
        <FROM_PK>GU_CATEGORY,GU_CATEGORY</FROM_PK>
        <TO_PK>GU_CATEGORY,GU_CATEGORY</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFER(K_CATEGORIES.GU_CATEGORY)">GU_CATEGORY,GU_CATEGORY</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_X_CAT_GROUP_ACL</FROM>
        <TO>K_X_CAT_GROUP_ACL</TO>
        <WHERE>GU_ACL_GROUP IN (SELECT GU_ACL_GROUP FROM K_ACL_GROUPS WHERE ID_DOMAIN=?) AND GU_CATEGORY IN (SELECT GU_CATEGORY FROM K_CATEGORIES WHERE NM_CATEGORY LIKE 'MODEL%')</WHERE>
        <FROM_PK>GU_CATEGORY,GU_ACL_GROUP</FROM_PK>
        <TO_PK>GU_CATEGORY,GU_ACL_GROUP</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFER(K_CATEGORIES.GU_CATEGORY)">GU_CATEGORY,GU_CATEGORY</MAPPING>
        <MAPPING TRANSFORM="REFER(K_ACL_GROUPS.GU_ACL_GROUP)">GU_ACL_GROUP,GU_ACL_GROUP</MAPPING>
      </MAPPINGS>
    </ROWSET>
    <ROWSET>
      <ACTION>
        <FROM>K_X_CAT_USER_ACL</FROM>
        <TO>K_X_CAT_USER_ACL</TO>
        <WHERE>GU_USER IN (SELECT GU_USER FROM K_USERS WHERE ID_DOMAIN=?) AND GU_CATEGORY IN (SELECT GU_CATEGORY FROM K_CATEGORIES WHERE NM_CATEGORY LIKE 'MODEL%')</WHERE>
        <FROM_PK>GU_CATEGORY,GU_USER</FROM_PK>
        <TO_PK>GU_CATEGORY,GU_USER</TO_PK>
      </ACTION>
      <MAPPINGS>
        <MAPPING TRANSFORM="REFER(K_CATEGORIES.GU_CATEGORY)">GU_CATEGORY,GU_CATEGORY</MAPPING>
        <MAPPING TRANSFORM="REFER(K_USERS.GU_USER)">GU_USER,GU_USER</MAPPING>
      </MAPPINGS>
    </ROWSET>
  </ROWSETS>
</DATASTRUCT>